---
title: "Assignment 4, MSB 105, 2025"
author: Karin Liang
format:
  pdf:
    fig-cap-location: bottom
    fig-number: true
  html:
    fig-cap-location: bottom
    fig-number: true
editor: visual
---

# Pakker

```{r}
#| label: setup
#| message: false
library(tidyverse)
library(readxl)
library(restatapi)
library(DescTools)
library(ggrepel)
library(flextable)
library(modelr)
library(plm)
library(broom)
library(sandwich)
library(dplyr)
library(tidyr)
library(ggplot2)
```

# Toc.eurostat

```{r}
# xml skal ha mer detaljert info
# toc_xml <- get_eurostat_toc()
# tekstversjonen har trolig nok info for vårt formål

toc_txt <- get_eurostat_toc(mode = "txt")
```

# GDP NUTS 3

```{r}
gdp_tabs <- toc_txt |> 
# Regex AND external to regex
   filter(
     str_detect(
       string = title,
       # For å matche både små og store bokstaver
       pattern = '[Gg][Dd][Pp]'
       # AND vha. &
       ) &
     str_detect(
       string = title,
       # For å matche både små og store bokstaver og
       # space eller ikke før 3
       pattern = '[Nn][Uu][Tt][Ss]\\s*3'
       )
     ) |> 
  select(title, code)

```

```{r}
gdp_tabs |> 
  select(title, code) |> 
  flextable()  |> 
  width(1, width = 3.5) |> 
  width(2, width = 1.5)
```

```{r}
# description nama_10r_3gdp
dsd_gdp <- get_eurostat_dsd("nama_10r_3gdp")

```

```{r}
dsd_gdp |> 
  filter(concept %in% c('freq', 'unit')) |> 
  flextable()  |> 
  width(j = 1, width = 1) |> 
  width(j = 2, width = 2) |> 
  width(j = 3, width = 2)
```

```{r}
dsd_gdp |> 
  filter(concept %in% c('geo')) |> 
  head(n = 10) |> 
  flextable()  |> 
  width(j = 1, width = 1) |> 
  width(j = 2, width = 2) |> 
  width(j = 3, width = 2)
```

```{r}
#| eval: true
#| cache: true
# Gross domestic product (GDP) at current market prices by NUTS 3 regions 
# id: nama_10r_3gdp
# Vi velger å hente samtlige soner for så å filtrere ut de få vi ikke trenger
gdp <- get_eurostat_data(
  id = "nama_10r_3gdp",
  filters = list(
    # neste linje viser hvordan vi kunne ha hentet ut data
    # for spesifiserte land
    # geo = c("AT", "DE", "DK", "FR"),
    nuts_level = "3",
    unit = "MIO_PPS_EU27_2020"
  ),
  exact_match = FALSE,
  date_filter = 2000:2023,
  stringsAsFactors = FALSE
  ) |> 
  mutate(
    gdp_n3 = 1000000 * values
  ) |> 
  select(-c(unit, values)) |> 
  # Vil bare ha NUTS 3 nivå (5 karakterer). Vil aggregere selv til NUTS2,
  # NUTS1 og NUTSc  
  filter(str_length(geo) == 5) |> 
  as_tibble()
```

```{r}
dim(gdp)
```

```{r}
gdp
```

```{r}
gdp |> 
  filter(geo == "IE053") |> 
  print(n = 25)
```

```{r}
ie_data <- tibble(
  geo = c("IE053", "IE053", "IE053"),
  time = c("2015", "2016", "2017"),
  gdp_n3 = c(NA, NA, NA)
)
```

```{r}
gdp <- rbind(gdp, ie_data)
```

```{r}
gdp <- gdp |> 
  arrange(geo, time) |> 
  mutate(
    gdp_n3 = zoo::na.approx(gdp_n3)
  )
```

```{r}
gdp |> 
  filter(geo == "IE053") |> 
  print(n = 25)
```

# Population

## Oppgave 1

```{r}
# Søk i toc_txt etter tabeller som inneholder både population og NUTS 3
# Vi bruker regexp for å dekke både små og store bokstaver og ulike skrivemåter

pop_tabs <- toc_txt |>
  filter(
    str_detect(
      string  = title,
      pattern = "[Pp]opulation"
    ) &
      str_detect(
        string  = title,
        pattern = "[Nn][Uu][Tt][Ss]\\s*3"
      )
  ) |>
  select(title, code)

pop_tabs |>
  flextable() |>
  width(1, width = 5) |>
  width(2, width = 2)

```

## Oppgave 2

```{r}
# Last ned Data Structure Definition (DSD) for nama_10r_3popgdp

dsd_pop <- get_eurostat_dsd("nama_10r_3popgdp")

```

```{r}
dsd_pop |>
  filter(concept %in% c("freq", "unit", "geo")) |>
  flextable() |>
  width(j = 1, width = 1) |>
  width(j = 2, width = 2) |>
  width(j = 3, width = 2)

```

```{r}
# Bruk DSD-informasjonen til å laste ned pop-data på NUTS3-nivå
pop <- get_eurostat_data(
  id = "nama_10r_3popgdp",
  filters = list(
    freq = "A",       # Annual
    unit = "THS"     # Thousand (jf. DSD-tabellen over)
  ),
  exact_match = FALSE,
  date_filter = 2000:2023,
  stringsAsFactors = FALSE
) |>
  mutate(pop_n3 = 1000 * values) |>
  select(geo, time, pop_n3) |>
  filter(str_length(geo) == 5) |>
  as_tibble()

```

```{r}
dim(pop)
```

```{r}
pop
```

## Oppgave 3

```{r}
# Slå sammen GDP- og befolkningstabellene
# Viktig: gdp skal være venstre tabell

gdp_pop <- gdp |>
  left_join(pop, by = c("geo", "time"))
```

```{r}
eu_data <- gdp_pop %>%
  # Trenger ikke ZZ sonene som er en slag oppsamlingssone
  # for ikke fordelte verdier
  filter(!str_sub(geo, 3, 4) == "ZZ") |> 
  # Drop the EFTA countries Switzerland and Norway
  filter(!str_sub(geo, 1, 2) %in% c("CH", "NO")) |> 
  # Drop the EU countries Netherlands and Portugal
  filter(!str_sub(geo, 1, 2) %in% c("NL", "PT")) |> 
  # Drop candidate country Monte Negro because of data
  filter(!str_sub(geo, 1, 2) %in% c("ME")) |> 
  # Drop a region of France in the Indian Ocean (Outre Mer); Mayotte
  # because of missing data
  filter(!geo == "FRY50") |> 
  # note that a few countries will have missing data for
  # some years at the start of the period
  filter(time > 1999 & time < 2023)

```

```{r}
eu_data <- eu_data |>
  mutate(
  gdp_pc_n3 = gdp_n3 / pop_n3
)
```

```{r}
dim(eu_data)
```

```{r}

dim(
  eu_data |>
    filter(is.na(gdp_pc_n3))
)
```

## Oppgave 4

```{r}
# Endre geo til n3 og lag variablene n2, n1 og nc

eu_data <- eu_data |>
  # Endrer navnet fra geo til n3
  rename(n3 = geo) |>
  
  # Lager nye variabler basert på n3-koden
  mutate(
    n2 = str_sub(n3, 1, 4),   # NUTS2: første 4 tegn
    n1 = str_sub(n3, 1, 3),   # NUTS1: første 3 tegn
    nc = str_sub(n3, 1, 2)    # Landskode: første 2 tegn
  )

```

```{r}
eu_data |>
  select(n3, n2, n1, nc) |>
  head(10)
```

## Oppgave 5

```{r}
# Sjekk om noen NUTS3-soner har pop_n3 lik 0, og sett disse til NA

# Sjekker om det finnes verdier som er 0
sum(eu_data$pop_n3 == 0, na.rm = TRUE)
```

```{r}
# Setter pop_n3 = 0 til NA dersom slike finnes
eu_data <- eu_data |>
  mutate(
    pop_n3 = ifelse(pop_n3 == 0, NA, pop_n3)
  )
```

## Oppgave 6

```{r}
# Teller antall unike NUTS3-soner i hvert land
nuts3_per_land <- eu_data |>
  group_by(nc) |>
  summarise(Antall = n_distinct(n3)) |>
  arrange(nc)

# Teller hvor mange land (nc) vi har totalt
n_lands <- nuts3_per_land |> summarise(n = n()) |> pull(n)

# Lager flextable og legger til en footer med "n: xx"
flextable_nuts3 <- nuts3_per_land |>
  flextable() |>
  width(j = 1, width = 1) |>
  width(j = 2, width = 1) |>
  add_footer_lines(values = paste0("n: ", n_lands)) |>
  align(align = "left", part = "footer")

flextable_nuts3
```

## Oppgave 7

```{r}
# Sjekk summary for gdp_pc_n3
# Viser et standard summary for variabelen gdp_pc_n3
summary(eu_data$gdp_pc_n3)
```

```{r}
# Minste verdi
min_gdp_pc <- min(eu_data$gdp_pc_n3, na.rm = TRUE)
min_gdp_pc

# Største verdi
max_gdp_pc <- max(eu_data$gdp_pc_n3, na.rm = TRUE)
max_gdp_pc

# Antall NA-verdier i gdp_pc_n3
sum(is.na(eu_data$gdp_pc_n3))
```

Datasettet gdp_pc_n3 har 0 NAV-verdie, og den minste verdien er 2214, mens den største verdien er 180416.

## Oppgave 8

```{r}
# Legg til variabelen nc_name basert på landskode (nc)

eu_data <- eu_data |>
  mutate(
    nc_name = case_when(
      nc == "AL" ~ "Albania",
      nc == "AT" ~ "Østerrike",
      nc == "BE" ~ "Belgia",
      nc == "BG" ~ "Bulgaria",
      nc == "CY" ~ "Kypros",
      nc == "CZ" ~ "Tjekkia",
      nc == "DE" ~ "Tyskland",
      nc == "DK" ~ "Danmark",
      nc == "EE" ~ "Estland",
      nc == "EL" ~ "Hellas",
      nc == "ES" ~ "Spania",
      nc == "FI" ~ "Finland",
      nc == "FR" ~ "Frankrike",
      nc == "HR" ~ "Kroatia",
      nc == "HU" ~ "Ungarn",
      nc == "IE" ~ "Irland",
      nc == "IT" ~ "Italia",
      nc == "LT" ~ "Litauen",
      nc == "LU" ~ "Luxembourg",
      nc == "LV" ~ "Latvia",
      nc == "MK" ~ "Nord-Makedonia",
      nc == "MT" ~ "Malta",
      nc == "PL" ~ "Polen",
      nc == "RO" ~ "Romania",
      nc == "RS" ~ "Serbia",
      nc == "SE" ~ "Sverige",
      nc == "SI" ~ "Slovenia",
      nc == "SK" ~ "Slovakia",
      nc == "TR" ~ "Tyrkia",
      TRUE ~ NA_character_
    )
  )

```

```{r}
eu_data |>
  select(nc_name, nc) |>
  distinct() |>
  print(n = 30)

```

# Beregning av Gini på NUTS2, NUTS1 og NUTSc nivå

## Oppgave 9

```{r}
# Beregne Gini-koeffisienter på NUTS2 nivå

gini_n2 <- eu_data |>
  group_by(n2, time, n1, nc, nc_name) |>
  summarise(
    gini_n2 = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
    pop_n2  = sum(pop_n3),
    gdp_n2  = sum(gdp_n3),
    gdp_pc_n2 = gdp_n2 / pop_n2,
    num_reg_n2 = n(),
    .groups = "drop"
  )

# Kort oversikt
gini_n2 |>
  select(gini_n2, num_reg_n2, gdp_n2, pop_n2, gdp_pc_n2) |>
  summary() 

```

## Oppgave 10

```{r}
gini_n2 |>
  filter(gini_n2 < 0.001) |>
  arrange(num_reg_n2) |>
  select(nc_name, nc, n1, n2, time, gini_n2, num_reg_n2) |>
  print(n = 10)
```

Disse regionene består av svært få NUTS3-soner, og lav Gini skyldes derfor datastrukturen snarere enn reelle regionale forskjeller.

## Oppgave 11

```{r}
# Beregner Gini-koeffisienter og økonomiske nøkkeltall på NUTS1 nivå
gini_n1 <- eu_data |>
  group_by(n1, time, nc, nc_name) |>
  summarise(
    gini_n1   = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
    pop_n1    = sum(pop_n3),
    gdp_n1    = sum(gdp_n3),
    gdp_pc_n1 = gdp_n1 / pop_n1,
    num_reg_n1 = n(),
    .groups = "drop"
  )

# Summary
gini_n1 |>
  select(gini_n1, num_reg_n1, gdp_n1, pop_n1, gdp_pc_n1) |>
  summary() |>
  print(width = 76)

```

## Oppgave 12

```{r}
# Beregner Gini-koeffisienter på landsnivå (NUTSc), basert på NUTS3-verdier
gini_nc <- eu_data |>
  group_by(nc, nc_name, time) |>
  summarise(
    gini_nc   = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
    pop_nc    = sum(pop_n3),
    gdp_nc    = sum(gdp_n3),
    gdp_pc_nc = gdp_nc / pop_nc,
    num_reg_nc = n(),         # antall NUTS3 i landet
    .groups = "drop"
  )

# Summary
gini_nc |>
  select(gini_nc, num_reg_nc, gdp_nc, pop_nc, gdp_pc_nc) |>
  summary() |>
  print(width = 80)

```

# «Nestete» datastrukturer

## Oppgave 13

```{r}
# Nest dataene på NUTS3 nivå
gini_n3_nest <- eu_data |> 
  group_by(nc_name, nc) |> 
  nest(.key = "NUTS3_data") |> 
  ungroup()
```

## Oppgave 14

```{r}
gini_NUTS2_nest <- gini_n2 |>
  group_by(nc_name, nc) |>    
  nest(.key = "NUTS2_data") |>   
  ungroup()

```

## Oppgave 15

```{r}
gini_NUTS1_nest <- gini_n1 |>
  group_by(nc_name, nc) |>
  nest(.key = "NUTS1_data") |>   
  ungroup()

```

## Oppgave 16

```{r}
gini_NUTSc_nest <- gini_nc |>
  group_by(nc_name, nc) |>
  nest(.key = "NUTSc_data") |>  
  ungroup()
```

## Oppgave 17

```{r}
gini_NUTSeu_nest <- eu_data |>
  group_by(time) |>
  summarise(
    gini_eu = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
    num_reg_eu = n(),
    .groups = "drop"
  )

```

## Oppgave 18

```{r}
gini_NUTSeu_nest <- gini_NUTSeu_nest |>
  mutate(time = as.numeric(time))  
```

```{r}
#| label: fig-gini-eu
#| fig-cap: "Utvikling i Gini-koeffisienten for NUTS3-regioner i EU."

ggplot(gini_NUTSeu_nest, aes(x = time, y = gini_eu)) +
  geom_line() +
  theme_minimal() +
  labs(
    title = "Regional ulikhet i EU",
    x = "Year",
    y = "gini_eu"
  )

```

## Oppgave 19

Gini-koeffisienten mellom NUTS3-regioner viser en tydelig fallende trend over tid, slik @fig-gini-eu illustrerer. Dette innebærer at regionale forskjeller gradvis reduseres. En slik utvikling er i tråd med målet om å styrke mindre utviklede områder gjennom EUs strukturfond. @fig-gini-eu indikerer også at tiltaket kan ha ønsket effekt.

## Oppgave 20

```{r}
# Kombinerer 
eu_data_nested <- gini_n3_nest |>
  left_join(gini_NUTS2_nest, by = c("nc", "nc_name")) |>
  left_join(gini_NUTS1_nest, by = c("nc", "nc_name")) |>
  left_join(gini_NUTSc_nest, by = c("nc", "nc_name"))

```

# Plots som viser utviklingen

## Oppgave 21

```{r}
#| label: fig-gini-nc
#| fig-cap: "Utviklingen over tid for Gini-koeffisienten på nasjonsnivå for de 29 landene. Gini-koeffisienten måler hvordan verdiskapingen i landet er fordelt mellom NUTS3-regioner."

gini_nc |>
  filter(!is.na(gini_nc)) |>
  mutate(time = as.integer(time)) |>
  ggplot(aes(
    x = time,
    y = gini_nc,
    group = nc_name,
    color = nc_name
  )) +
  geom_line() +
  theme_minimal() +
  labs(
    title = "Regional ulikhet over tid",
    x = "time",
    y = "gini_nc",
    color = "nc_name"
  )

```

## Oppgave 22

```{r}
#| label: tbl-gini-2022
#| tbl-cap: "Gini-koeffisient for BNP i 2022. Kypros og Luxembourg har bare en NUTS3-region og dermed ingen Gini-koeffisient."

gini_nc |>
  filter(time == 2022) |>
  arrange(desc(gini_nc)) |>
  select(nc_name, gini_nc) |>
  knitr::kable(digits = 7)


```

## Oppgave 23

```{r}
gini_series <- gini_nc |>
  transmute(
    country = nc_name,
    year    = as.integer(time),
    gini    = gini_nc
  ) |>
  filter(!is.na(gini), !is.nan(gini)) |>
  arrange(country, year) |>
  group_by(country) |>
  mutate(
    gini_first = first(gini),
    year_comp  = if (any(year == 2022L)) 2022L else last(year),
    gini_comp  = if (any(year == 2022L)) gini[year == 2022L][1] else last(gini),
    group      = if_else(gini_comp < gini_first, "Lower", "Higher")
  ) |>
  ungroup()

```

```{r}
#| label: fig-gini-lower
#| fig-cap: "Land med lavere regional ulikhet i 2022 enn første år vi har data for."
gini_series |>
  filter(group == "Lower") |>
  ggplot(aes(year, gini, colour = country, group = country)) +
  geom_line() +
  labs(title = "Lavere regional ulikhet", x = "Year", y = "Gini-koeffisient", colour = "Land"
  ) +
  theme_minimal()

```

```{r}
#| label: fig-gini-higher
#| fig-cap: "Land med høyere regional ulikhet i 2022 enn første år vi har data for."
gini_series |>
  filter(group == "Higher") |>
  ggplot(aes(year, gini, colour = country, group = country)) +
  geom_line() +
  labs(title = "Høyere regional ulikhet", x = "Year", y = "Gini-koeffisient", colour = "Land"
  ) +
  theme_minimal()

```

## Oppgave 24

```{r}
#| label: fig-gini-ie-n2
#| fig-cap: "Utviklingen i Gini-koeffisienten for NUTS2-regionene i Irland."

gini_n2 |>
  filter(nc == "IE", !is.na(gini_n2)) |>
  mutate(time = as.integer(time)) |>
  ggplot(aes(x = time, y = gini_n2, group = n2, color = n2)) +
  geom_line() +
  scale_x_continuous(
    breaks = seq(2000, 2022, by = 5)
  ) +
  theme_minimal() +
  labs(
    title = "Regional ulikhet i Irland",
    x = "Year",
    y = "gini_n2",
    color = "n2"
  )

```

# Hvordan er verdiskapningen fordelt mellom regionene i ulike land?

## Spania

## Oppgave 25

```{r}
#| label: fig-gini-es-n2
#| fig-cap: "Utviklingen i Gini-koeffisienten for NUTS2-regionene i Spania."

gini_n2 |>
  filter(nc == "ES", !is.na(gini_n2)) |>
  mutate(time = as.integer(time)) |>
  ggplot(aes(x = time, y = gini_n2, group = n2, colour = n2)) +
  geom_line() +
  scale_x_continuous(breaks = seq(2000, 2022, by = 5)) +
  labs(
    title = "Regional (NUTS2) ulikhet i Spania",
    x = "Year",
    y = "gini_n2",
    colour = "n2"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom"
  )

```

## Oppgave 26

```{r}
#| label: fig-gini-es-n1
#| fig-cap: "Utviklingen i Gini-koeffisienten for NUTS1-regionene i Spania."

gini_n1 |>
  filter(nc == "ES", !is.na(gini_n1)) |>
  mutate(time = as.integer(time)) |>
  ggplot(aes(x = time, y = gini_n1, group = n1, colour = n1)) +
  geom_line() +
  scale_x_continuous(breaks = seq(2000, 2022, by = 5)) +
  labs(
    title  = "Regional (NUTS1) ulikhet i Spania",
    x      = "Year",
    y      = "gini_n1",
    colour = "n1"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

```

NUTS1-regionene som har hatt økt utjevning kjennetegnes av en fallende eller stabil Gini-koeffisient over tid. Dette indikerer mindre forskjeller i verdiskaping mellom regionene innen disse områdene. Samtidig varierer utviklingen mellom regionene, og figuren alene gir ikke grunnlag for å trekke sterke konklusjoner om årsakene.

## Tyskland

## Oppgave 27

```{r}
#| label: fig-gini-de-n2
#| fig-cap: "Utviklingen i Gini-koeffisienten for NUTS2-regionene i Tyskland."

gini_n2 |>
  filter(nc == "DE", !is.na(gini_n2)) |>
  mutate(time = as.integer(time)) |>
  ggplot(aes(x = time, y = gini_n2, group = n2)) +
  geom_line(colour = "black", alpha = 0.7) +
  scale_x_continuous(breaks = seq(2000, 2022, by = 5)) +
  labs(
    title = "Regional (NUTS2) ulikhet i Tyskland",
    x = "Year",
    y = "gini_n2"
  ) +
  theme_minimal()

```

```{r}
# Finner NUTS2-regionen i Tyskland med høyest observert Gini-koeffisient.

gini_n2 |>
  filter(nc == "DE", !is.na(gini_n2)) |>
  group_by(n2) |>
  summarise(
    max_gini = max(gini_n2),
    .groups = "drop"
  ) |>
  arrange(desc(max_gini)) |>
  slice(1)
```

Fra @fig-gini-de-n2 ser vi at Gini-koeffisientene for NUTS2-regionene i Tyskland i analyseperioden varierer omtrent fra 0,03 til over 0,45, noe som indikerer betydelige forskjeller mellom regionene. Enkelte NUTS2-regioner har gjennom hele perioden Gini-koeffisienter som ligger klart høyere enn øvrige regioner, noe som tyder på større interne regionale forskjeller, mens andre regioner over tid har hatt gjennomgående lavere nivåer.

Basert på dataene kan regionen med de største observerte regionale forskjellene identifiseres som NUTS2-regionen DE91, som ifølge [Wikipedia: NUTS statistical regions of Germany](https://en.wikipedia.org/wiki/NUTS_statistical_regions_of_Germany) tilsvarer Braunschweig. Denne geografiske plasseringen kan imidlertid ikke leses direkte ut av figuren alene, men fremkommer først når NUTS-kodene kobles til tilhørende regioninformasjon.

## Oppgave 28

```{r}
#| label: fig-gini-de-n1
#| fig-cap: "Utviklingen i Gini-koeffisienten for NUTS1-regionene i Tyskland."

gini_n1 |>
  filter(nc == "DE", !is.na(gini_n1)) |>
  mutate(time = as.integer(time)) |>
  ggplot(aes(
    x = time,
    y = gini_n1,
    group = n1,
    colour = n1
  )) +
  geom_line() +
  scale_x_continuous(breaks = seq(2000, 2022, by = 5)) +
  labs(
    title  = "Regional (NUTS1) ulikhet i Tyskland",
    x      = "Year",
    y      = "Gini-koeffisient",
    colour = "n1"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right"
  )

```

```{r}
eu_data_nested |> 
  unnest(NUTS1_data) |> 
  filter(nc_name == "Tyskland") |> 
  filter(time == "2022") |>
  select(n1, gini_n1, num_reg_n1) |> 
  arrange(desc(gini_n1)) |> 
  flextable() |> 
  line_spacing(space = 0.3) |> 
  colformat_double(j = 2, digits = 4)
```

## Frakrike

## Oppgave 29

```{r}
#| label: fig-gini-fr-n1
#| fig-cap: "Utviklingen i Gini-koeffisienten for NUTS1-regionene i Frankrike."

gini_n1 |>
  filter(nc == "FR", !is.na(gini_n1)) |>
  mutate(time = as.integer(time)) |>
  ggplot(aes(
    x = time,
    y = gini_n1,
    group = n1,
    colour = n1
  )) +
  geom_line() +
  scale_x_continuous(breaks = seq(2000, 2022, by = 5)) +
  labs(
    title  = "Regional (NUTS1) ulikhet i Frankrike",
    x      = "Year",
    y      = "gini_n1",
    colour = "n1"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right"
  )

```

## Oppgave 30

```{r}
# Viser de seks NUTS1-regionene i Frankrike med høyest Gini-koeffisient i 2022.

top6_fr_n1_2022 <- gini_n1 |>
  filter(nc == "FR", time == 2022, !is.na(gini_n1)) |>
  arrange(desc(gini_n1)) |>
  select(n1, gini_n1) |>
  slice_head(n = 6)

top6_fr_n1_2022

```

Basert på tabellen ser vi at NUTS1-sonen FR1 har suverent høyest Gini-koeffisient i 2022, med en verdi på 0,335, som er klart høyere enn de øvrige regionene. Ifølge [Wikipedia: NUTS statistical regions of France](https://en.wikipedia.org/wiki/NUTS_statistical_regions_of_France) tilsvarer FR1 regionen Île-de-France, som ligger i og rundt Paris-området. Dette innebærer at de største regionale forskjellene i Frankrike i 2022 er konsentrert i hovedstadsregionen.

## Oppgave 31

```{r}
#| label: fig-gdp-fr1-n3
#| fig-cap: "BNP per innbygger i NUTS3-regionene i Île-de-France."

eu_data |>
  filter(nc == "FR", n1 == "FR1", !is.na(gdp_pc_n3)) |>
  mutate(time = as.integer(time)) |>
  ggplot(aes(
    x = time,
    y = gdp_pc_n3,
    group = n3,
    colour = n3
  )) +
  geom_line() +
  theme_minimal() +
  labs(
    title = "BNP per innbygger i NUTS3-regionene i Île-de-France",
    x = "År",
    y = "GDP per capita",
    colour = "NUTS3"
  )
```

```{r}
# Viser BNP per innbygger i 2022 for NUTS3-regionene i FR1.
eu_data |>
  filter(nc == "FR", n1 == "FR1", time == 2022, !is.na(gdp_pc_n3)) |>
  arrange(desc(gdp_pc_n3)) |>
  select(n3, gdp_pc_n3)

```

## Oppgave 32

Ja. Ut fra @fig-gdp-fr1-n3 kan vi se at FR1 (Île-de-France) har betydelige interne forskjeller i BNP per innbygger mellom NUTS3-regionene. I 2022 ligger Paris (FR101) og Hauts-de-Seine (FR105) på et svært høyt nivå, med BNP per innbygger på om lag 100 000–115 000, mens de øvrige NUTS3-regionene i FR1 i hovedsak ligger i intervallet rundt 29 000–39 000. Denne tydelige konsentrasjonen av svært høye verdier i noen få NUTS3-regioner, kombinert med betydelig lavere nivåer i resten av regionen, bidrar til å trekke Gini-koeffisienten for FR1 opp.

# Enkle modeller

## Oppgave 33

```{r}
n3_data <- eu_data_nested |> 
  unnest(NUTS3_data) |> 
  select(nc_name, n2, n3, time, gdp_pc_n3)
```

```{r}
n2_data <- eu_data_nested |> 
  unnest(NUTS2_data) |> 
  select(nc_name, n2, time, gini_n2)
```

```{r}
NUTS2_diff <- n3_data |> 
  left_join(n2_data, by = join_by(nc_name, n2, time)) |> 
  mutate(
    diff_gdp_per_capita = c(NA, 100 * diff(gdp_pc_n3)),
    diff_gini_nuts2 = c(NA, 100 * diff(gini_n2))
  ) %>%
  filter(complete.cases(.)) |> 
  group_by(nc_name, n2) |> 
  nest(.key = "NUTS2_diff")
```

```{r}
unnest(NUTS2_diff, NUTS2_diff) |> 
  ungroup() |> 
  filter(!is.nan(gini_n2)) |> 
  select(n2) |> 
  distinct() |> 
  nrow()
```

## Oppgave 34

```{r}
NUTS2_diff <- NUTS2_diff  |> 
  group_by(nc_name, n2) |> 
  mutate(
    modell = map(
      .x = NUTS2_diff,
      .f = function(a_df) lm('diff_gini_nuts2 ~ diff_gdp_per_capita', data = a_df)
    )
  )
```

## Oppgave 35

```{r}
NUTS2_diff <- NUTS2_diff |>
  group_by(nc_name, n2) |>
  mutate(
    mod_coeff = bind_rows(
      map(.x = modell, .f = coef)
    )
  )
```

## Oppgave 36

```{r}
NUTS2_diff <- NUTS2_diff  |> 
  group_by(nc_name, n2) |> 
  mutate(
    mod_sum = bind_rows(
      map(
        .x = modell,
        .f = glance
        )
    )
    )
```

## Oppgave 37

```{r}
# Viser de tre NUTS2-regionene med høyest R² i modellen

top3_r2 <- NUTS2_diff |>
  ungroup() |>
  tidyr::unnest(mod_sum) |>
  filter(!is.na(r.squared), !is.nan(r.squared)) |>
  arrange(desc(r.squared), nc_name, n2) |>
  select(nc_name, n2, NUTS2_diff, modell, mod_coeff, r.squared) |>
  slice(1:3)
top3_r2

```

```{r}
# Viser de tre NUTS2-regionene med lavest R² i modellen

bot3_r2 <- NUTS2_diff |>
  ungroup() |>
  tidyr::unnest(mod_sum) |>
  filter(!is.na(r.squared), !is.nan(r.squared)) |>
  arrange(r.squared, nc_name, n2) |>
  select(nc_name, n2, NUTS2_diff, modell, mod_coeff, r.squared) |>
  slice(1:3)
bot3_r2

```

## Oppgave 38

```{r}
# Viser de tre NUTS2-regionene med høyest koeffisient for diff_gdp_per_capita

top3_coeff <- NUTS2_diff |>
  ungroup() |>
  mutate(coeff_diff_gdp = mod_coeff$diff_gdp_per_capita) |>
  filter(!is.na(coeff_diff_gdp), !is.nan(coeff_diff_gdp)) |>
  arrange(desc(coeff_diff_gdp), nc_name, n2) |>
  select(nc_name, n2, NUTS2_diff, modell, coeff_diff_gdp) |>
  slice(1:3)

top3_coeff

```

## Oppgave 39

```{r}
# Teller hvor mange koeffisienter for diff_gdp_per_capita som er signifikante på 5%-nivå

signifikante_koeff <- NUTS2_diff |>
  ungroup() |>
  tidyr::unnest(mod_sum) |>
  filter(!is.na(p.value), !is.nan(p.value)) |>
  filter(p.value < 0.05) |>
  nrow()

signifikante_koeff

```

162 av de 218 estimerte koeffisientene er signifikante på 5 % nivå.

## Oppgave 40

```{r}
# Slår sammen NUTS2-nivådata 
d <- NUTS2_diff |> tidyr::unnest(NUTS2_diff)

# Beregner 99,5-persentilen av absoluttverdiene til diff_gdp_per_capita
q <- quantile(abs(d$diff_gdp_per_capita), 0.995, na.rm = TRUE)

# Definerer en skaleringsfaktor
scale_factor <- q / 1e-05

# Skalerer diff_gdp_per_capita ved å dele på skaleringsfaktoren
d <- d |> mutate(diff_gdp_scaled = diff_gdp_per_capita / scale_factor)
```

```{r}
#| label: fig-density-diff-gdp
#| fig-cap: "Tetthetsplott av diff_gdp_per_capita med stiplet linje for gjennomsnittet."

ggplot(d, aes(x = diff_gdp_scaled)) +
  geom_density(
    na.rm = TRUE,
    color = "black",
    linewidth = 1,
    bw = 2e-06
  ) +
  geom_vline(
    xintercept = mean(d$diff_gdp_scaled, na.rm = TRUE),
    linetype = "dashed",
    color = "grey40"
  ) +
  coord_cartesian(xlim = c(-2e-05, 1e-05)) +
  labs(
    title = "Tetthetsfordeling av diff_gdp_per_capita",
    x = "diff_gdp_per_capita",
    y = "density"
  ) +
  theme_grey()

```

## Oppgave 41

```{r}
# Teller hvor mange regresjonskoeffisienter for diff_gdp_per_capita som er positive

positive_coeff <- NUTS2_diff |>
  ungroup() |>
  mutate(coeff_diff_gdp = mod_coeff$diff_gdp_per_capita) |>
  filter(!is.na(coeff_diff_gdp)) |>
  summarise(
    totalt = n(),
    positive = sum(coeff_diff_gdp > 0)
  )

positive_coeff

```

132 av de 218 estimerte regresjonskoeffisientene for diff_gdp_per_capita er X positive.

## Oppgave 42

```{r}
NUTS2_diff |>
  ungroup() |>
  mutate(coeff_diff_gdp = mod_coeff$diff_gdp_per_capita) |>
  filter(!is.na(coeff_diff_gdp)) |>
  summarise(
    mean_coeff = mean(coeff_diff_gdp),
    median_coeff = median(coeff_diff_gdp)
  )

```

## Oppgave 43

```{r}
# Utfører en ensidig t-test for å teste om gjennomsnittet av
# diff_gdp_per_capita er signifikant større enn 0

t_test_diff <- t.test(
  NUTS2_diff$mod_coeff$diff_gdp_per_capita,
  alternative = "greater",
  mu = 0
)

t_test_diff

```
Ja, diff_gdp_per_capita er signifikant større enn 0.

# Panel modell

## Oppgave 44

```{r}
d_panel <- d %>%
  ungroup() %>%  
  select(n3, time, diff_gini_nuts2, diff_gdp_per_capita) %>%
  filter(!is.na(n3), !is.na(time))

p_mod <- plm(
  diff_gini_nuts2 ~ diff_gdp_per_capita,
  data  = d_panel,
  index = c("n3", "time")
)
```

## Oppgave 45

```{r}
summary(p_mod)

```

## Oppgave 46
```{r}
s <- summary(p_mod)
s
```

 

 

